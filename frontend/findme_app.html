<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindMe | AI Identification System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (New UI Request) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            border: 'rgba(255, 255, 255, 0.1)',
                        },
                        primary: '#6366f1', // Indigo
                        accent: '#ec4899', // Pink
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        glow: {
                            'from': { boxShadow: '0 0 10px -10px #6366f1' },
                            'to': { boxShadow: '0 0 20px 5px #6366f1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Added for compatibility with inserted code */
        :root {
            --primary-color: #6366f1;
            --secondary-color: #ec4899;
        }
        
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: #f8fafc;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(17, 25, 40, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.125);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .glass-button {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Background Card Compatibility Class */
        .bg-card {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Form Snippet Compatibility Classes */
        .bg-input { background: rgba(0, 0, 0, 0.2); }
        .border-custom { border-color: rgba(255, 255, 255, 0.1); }
        .text-default { color: #f8fafc; }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-primary:hover { opacity: 0.9; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* Loader */
        .neon-loader {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            position: relative;
            animation: rotate 1s linear infinite;
        }
        .neon-loader::before {
            content: "";
            box-sizing: border-box;
            position: absolute;
            inset: 0px;
            border-radius: 50%;
            border: 5px solid #FFF;
            animation: prixClipFix 2s linear infinite;
        }
        @keyframes rotate { 100% {transform: rotate(360deg)} }
        @keyframes prixClipFix {
            0%   {clip-path:polygon(50% 50%,0 0,0 0,0 0,0 0,0 0)}
            25%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 0,100% 0,100% 0)}
            50%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,100% 100%,100% 100%)}
            75%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 100%)}
            100% {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 0)}
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col relative overflow-x-hidden selection:bg-primary selection:text-white">

    <!-- Decorative Background Blobs -->
    <div class="fixed top-20 left-10 w-72 h-72 bg-primary/20 rounded-full blur-[100px] -z-10 animate-float"></div>
    <div class="fixed bottom-20 right-10 w-96 h-96 bg-accent/20 rounded-full blur-[100px] -z-10 animate-float" style="animation-delay: 2s;"></div>

    <!-- NAVBAR -->
    <nav class="fixed w-full z-50 top-0 left-0 border-b border-glass-border glass-panel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo -->
                <div class="flex items-center cursor-pointer group" onclick="navigateTo('home')">
                    <div class="relative w-10 h-10 flex items-center justify-center bg-gradient-to-br from-primary to-accent rounded-xl shadow-lg mr-3 group-hover:scale-105 transition-transform">
                        <i class="ph-bold ph-fingerprint text-white text-xl"></i>
                    </div>
                    <span class="font-display font-bold text-2xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                        FindMe
                    </span>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <button onclick="navigateTo('home')" class="text-gray-300 hover:text-white text-sm font-medium transition-colors hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]">Home</button>
                    <button onclick="navigateTo('search-image')" class="text-gray-300 hover:text-white text-sm font-medium transition-colors hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]">AI Search</button>
                    <button onclick="navigateTo('dashboard')" id="nav-dashboard" class="hidden text-gray-300 hover:text-white text-sm font-medium transition-colors hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]">Dashboard</button>
                </div>

                <!-- Auth Buttons -->
                <div class="flex items-center gap-4">
                    <!-- Guest View -->
                    <div id="auth-guest" class="flex items-center gap-3">
                        <button onclick="navigateTo('login')" class="text-sm font-medium text-white hover:text-primary transition-colors">Login</button>
                        <button onclick="navigateTo('register')" class="px-5 py-2.5 rounded-xl bg-white text-black font-semibold text-sm hover:bg-gray-100 transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                            Sign Up
                        </button>
                    </div>

                    <!-- User Logged In View -->
                    <div id="auth-user" class="hidden flex items-center gap-4">
                        <div class="flex flex-col text-right hidden sm:block">
                            <span id="header-username" class="text-sm font-semibold text-white">User</span>
                            <span class="text-xs text-gray-400">Online</span>
                        </div>
                        <div class="relative group">
                            <button class="w-10 h-10 rounded-full bg-gradient-to-tr from-primary to-purple-600 flex items-center justify-center text-white font-bold shadow-lg border-2 border-transparent group-hover:border-white transition-all">
                                <span id="header-initial">U</span>
                            </button>
                            <!-- Dropdown -->
                            <div class="absolute right-0 mt-4 w-48 py-2 glass-panel rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                                <a href="#" onclick="navigateTo('dashboard')" class="block px-4 py-2 text-sm text-gray-300 hover:text-white hover:bg-white/5">Dashboard</a>
                                <div class="h-px bg-white/10 my-1"></div>
                                <a href="#" onclick="handleLogout()" class="block px-4 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10">Log Out</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="flex-grow pt-20 relative min-h-screen flex flex-col">
        <!-- Content injected here via JS -->
    </main>
    
    <!-- OTP MODAL (New) -->
    <div id="otpModal" class="fixed inset-0 bg-black bg-opacity-80 z-[60] hidden items-center justify-center backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-white/10">
            <h3 class="text-xl font-bold mb-3 text-white font-display">Enter OTP</h3>
            <p class="text-sm text-gray-300 mb-4" id="otpMessage">A verification code was sent to your email.</p>
        
            <input id="otpInput" type="text" maxlength="6"
                class="w-full p-3 rounded-lg glass-input border border-white/20 mb-4 text-white placeholder-gray-500 focus:border-primary text-center tracking-widest text-lg"
                placeholder="123456">
        
            <button id="verifyOtpBtn"
                class="w-full py-3 rounded-xl bg-gradient-to-r from-primary to-accent text-white font-bold shadow-lg shadow-primary/30 hover:shadow-primary/50 transition-all mb-2">
                Verify
            </button>
        
            <button onclick="closeOtpModal()"
                class="w-full py-2 text-gray-400 hover:text-white transition-colors text-sm">
                Cancel
            </button>
        </div>
    </div>

    <!-- === TEMPLATES (THE NEW UI COMPONENTS) === -->

    <!-- 1. HOME VIEW -->
    <template id="view-home">
        <div class="relative flex-grow flex items-center justify-center overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center z-10 animate-slide-up">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass-card mb-8">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    <span class="text-xs font-medium text-gray-300 uppercase tracking-wider">System Operational</span>
                </div>
                
                <h1 class="text-5xl md:text-7xl font-display font-bold mb-6 tracking-tight">
                    Find the Missing<br>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-400 to-accent">Using DeepFace AI</span>
                </h1>
                
                <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-400 mb-10 leading-relaxed">
                    A decentralized identification platform connecting families through advanced facial recognition and secure MySQL data storage.
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="navigateTo('search-image')" class="group relative px-8 py-4 bg-primary text-white rounded-xl font-semibold shadow-[0_0_40px_-10px_rgba(99,102,241,0.5)] overflow-hidden transition-transform hover:scale-105">
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        <span class="relative flex items-center gap-2">
                            <i class="ph-bold ph-scan text-xl"></i> Start AI Search
                        </span>
                    </button>
                    <button onclick="navigateTo('register')" id="cta-register" class="px-8 py-4 glass-card rounded-xl font-semibold text-white hover:bg-white/10 transition-colors flex items-center justify-center gap-2">
                        Create Account <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>

                <!-- Stats/Features -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-20 text-left">
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center text-primary mb-4">
                            <i class="ph-fill ph-brain text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Neural Matching</h3>
                        <p class="text-sm text-gray-400">Powered by DeepFace for precise vector similarity analysis.</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="w-12 h-12 bg-accent/20 rounded-lg flex items-center justify-center text-accent mb-4">
                            <i class="ph-fill ph-database text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Secure Flask Backend</h3>
                        <p class="text-sm text-gray-400">Robust Python API managing data persistence and security.</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center text-green-400 mb-4">
                            <i class="ph-fill ph-users text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Community Driven</h3>
                        <p class="text-sm text-gray-400">Crowdsourced reporting helping reunite loved ones faster.</p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- 2. LOGIN VIEW -->
    <template id="view-login">
        <div class="flex-grow flex items-center justify-center p-4">
            <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl animate-slide-up relative overflow-hidden">
                <!-- Decoration -->
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-primary/30 rounded-full blur-2xl"></div>

                <div class="text-center mb-8">
                    <h2 class="text-3xl font-display font-bold">Welcome Back</h2>
                    <p class="text-gray-400 text-sm mt-2">Access the secure identification network</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 uppercase mb-2 ml-1">Email Address</label>
                        <div class="relative">
                            <i class="ph-bold ph-envelope absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="email" id="loginEmail" required class="w-full glass-input rounded-xl py-3 pl-12 pr-4 text-sm focus:border-primary" placeholder="name@example.com">
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-primary to-indigo-600 rounded-xl font-bold text-white shadow-lg shadow-primary/30 hover:shadow-primary/50 transition-all transform hover:scale-[1.02]">
                        Authenticate with OTP
                    </button>

                    <!-- Google Sign-In Button Container -->
                    <div class="mt-4 flex justify-center">
                        <div id="googleBtn"></div>
                    </div>
                </form>

                <p class="text-center mt-8 text-sm text-gray-400">
                    No credentials? <button onclick="navigateTo('register')" class="text-primary hover:text-white font-medium transition-colors">Initialize Registration</button>
                </p>
            </div>
        </div>
    </template>

    <!-- 3. REGISTER VIEW -->
    <template id="view-register">
        <div class="flex-grow flex items-center justify-center p-4">
            <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl animate-slide-up relative">
                 <div class="text-center mb-8">
                    <h2 class="text-3xl font-display font-bold">New Account</h2>
                    <p class="text-gray-400 text-sm mt-2">Join the search network</p>
                </div>

                <form onsubmit="handleRegister(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 uppercase mb-2 ml-1">Full Name</label>
                        <div class="relative">
                            <i class="ph-bold ph-user absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="text" id="registerName" required class="w-full glass-input rounded-xl py-3 pl-12 pr-4 text-sm focus:border-primary" placeholder="John Doe">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 uppercase mb-2 ml-1">Email Address</label>
                        <div class="relative">
                            <i class="ph-bold ph-envelope absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="email" id="registerEmail" required class="w-full glass-input rounded-xl py-3 pl-12 pr-4 text-sm focus:border-primary" placeholder="name@example.com">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 uppercase mb-2 ml-1">Password</label>
                        <div class="relative">
                            <i class="ph-bold ph-lock-key absolute left-4 top-3.5 text-gray-500"></i>
                            <input type="password" id="registerPassword" required class="w-full glass-input rounded-xl py-3 pl-12 pr-4 text-sm focus:border-primary" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-accent to-pink-600 rounded-xl font-bold text-white shadow-lg shadow-accent/30 hover:shadow-accent/50 transition-all transform hover:scale-[1.02]">
                        Create Identity
                    </button>
                </form>

                <p class="text-center mt-8 text-sm text-gray-400">
                    Already registered? <button onclick="navigateTo('login')" class="text-accent hover:text-white font-medium transition-colors">Access Login</button>
                </p>
            </div>
        </div>
    </template>

    <!-- 4. DASHBOARD VIEW -->
    <template id="view-dashboard">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 animate-slide-up w-full">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                <div>
                    <h2 class="text-3xl font-display font-bold">Case Dashboard</h2>
                    <p class="text-gray-400">Manage your filed missing person reports.</p>
                </div>
                <button onclick="navigateTo('report-form')" class="px-6 py-3 bg-white text-black rounded-xl font-bold flex items-center gap-2 hover:bg-gray-200 transition-colors shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                    <i class="ph-bold ph-plus"></i> File New Report
                </button>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="glass-card p-6 rounded-2xl border-l-4 border-l-primary">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">Total Reports</p>
                    <p class="text-2xl font-bold mt-1" id="dash-total">Loading...</p>
                </div>
                <div class="glass-card p-6 rounded-2xl border-l-4 border-l-accent">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">Active Search</p>
                    <p class="text-2xl font-bold mt-1" id="dash-active">Loading...</p>
                </div>
                <div class="glass-card p-6 rounded-2xl border-l-4 border-l-green-500">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">System Status</p>
                    <p class="text-2xl font-bold mt-1 text-green-400">Online</p>
                </div>
            </div>

            <div id="reportsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Reports Injected Here -->
            </div>
        </div>
    </template>

    <!-- 5. REPORT FORM VIEW -->
    <template id="view-report-form">
        <div class="max-w-4xl mx-auto px-4 py-10 animate-slide-up w-full">
            <button onclick="navigateTo('dashboard')" class="mb-6 flex items-center text-gray-400 hover:text-white transition-colors">
                <i class="ph-bold ph-arrow-left mr-2"></i> Back to Dashboard
            </button>

            <div class="glass-panel p-8 md:p-10 rounded-3xl relative">
                <h2 class="text-2xl font-display font-bold mb-6 flex items-center gap-3">
                    <span class="p-2 bg-primary/20 rounded-lg text-primary"><i class="ph-bold ph-file-text"></i></span>
                    New Missing Person Report
                </h2>

                <form onsubmit="handleReportSubmission(event)" id="reportForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

                        <!-- Full Name -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">Full Name</label>
                            <input type="text" id="reportName" name="reportName" required
                                class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]"
                                placeholder="Enter full name">
                        </div>

                        <!-- Age -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">Age</label>
                            <input type="number" id="reportAge" name="reportAge" required
                                class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]"
                                placeholder="e.g. 29">
                        </div>

                        <!-- Gender -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">Gender</label>
                            <select id="reportGender" name="reportGender" required
                                class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]">
                                <option value="">Select gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Last Seen Date -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">Last Seen Date</label>
                            <input type="date" id="reportLastSeen" name="reportLastSeen" required
                                class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]">
                        </div>
                    </div>

                    <!-- Location + Phone -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

                        <!-- Location -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">Last Known Location</label>
                            <input type="text" id="reportLocation" name="reportLocation" required
                                class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]"
                                placeholder="e.g. Times Square, NY">
                        </div>

                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-300">Phone Number</label>
                            <input type="text" id="reportPhone" name="reportPhone" required
                                class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]"
                                placeholder="e.g. +1 555 000 0000">
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2 text-gray-300">Description / Notes</label>
                        <textarea id="reportDescription" name="reportDescription" rows="4" required
                            class="w-full p-3 rounded-lg bg-input border-custom border text-default focus:ring focus:ring-[var(--primary-color)]"
                            placeholder="Physical characteristics, clothing, etc."></textarea>
                    </div>

                    <!-- Photo Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2 text-gray-300">Upload Photo (Required)</label>
                        <input type="file" id="reportPhoto" name="reportPhoto" accept="image/*" required
                            class="w-full p-3 rounded-lg bg-input border-custom border text-default file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-[var(--primary-color)] file:text-white hover:file:bg-[var(--secondary-color)]">
                    </div>

                    <!-- Submit -->
                    <button type="submit" id="submitReportBtn"
                        class="w-full btn-primary text-lg py-3 rounded-lg shadow-lg">
                        Submit Report to Database
                    </button>
                </form>
            </div>
        </div>
    </template>

    <!-- 6. AI SEARCH VIEW -->
    <template id="view-search-image">
        <div class="max-w-5xl mx-auto px-4 py-10 animate-slide-up w-full">
            <div class="text-center mb-10">
                <span class="inline-block px-3 py-1 rounded-full bg-accent/20 text-accent text-xs font-bold mb-4 border border-accent/20">DEEPFACE ENGINE READY</span>
                <h2 class="text-4xl font-display font-bold">AI Identification</h2>
                <p class="text-gray-400 mt-2">Upload an image to compare facial features against the report database.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Search Input Panel -->
                <div class="lg:col-span-5">
                    <div class="glass-panel p-6 rounded-3xl h-full">
                        <form onsubmit="handleSearchSubmission(event)" id="searchForm" class="flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4">Input Source</h3>
                            
                            <div class="flex-grow border-2 border-dashed border-gray-600 rounded-2xl flex flex-col items-center justify-center p-6 hover:border-accent transition-colors relative min-h-[300px] bg-black/20">
                                <input type="file" id="searchPhoto" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" required onchange="handleFilePreview(this, 'preview-search')">
                                
                                <div id="search-placeholder" class="text-center pointer-events-none">
                                    <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4 text-gray-500">
                                        <i class="ph-bold ph-camera text-2xl"></i>
                                    </div>
                                    <p class="font-medium text-gray-300">Drop Image Here</p>
                                </div>
                                <img id="preview-search" class="absolute inset-0 w-full h-full object-contain p-4 hidden z-10">
                            </div>

                            <button type="submit" class="mt-6 w-full py-4 bg-gradient-to-r from-accent to-purple-600 rounded-xl font-bold text-white shadow-lg shadow-accent/30 hover:shadow-accent/50 transition-all flex items-center justify-center gap-2">
                                <i class="ph-bold ph-scan"></i> Run Analysis
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="lg:col-span-7">
                    <div class="glass-panel p-6 rounded-3xl min-h-[500px] flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg">Analysis Results</h3>
                            <div class="flex gap-2">
                                <span class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500"></span>
                                <span class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500"></span>
                                <span class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500 animate-pulse"></span>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="searchLoading" class="hidden flex-grow flex flex-col items-center justify-center text-center">
                            <div class="neon-loader mb-6 border-primary"></div>
                            <h4 class="text-xl font-bold animate-pulse text-white">Extracting Features...</h4>
                            <p class="text-sm text-gray-400 mt-2 mb-4">AI Processing Engine Active</p>
                            
                            <!-- Step 3: Add a place in UI to show progress -->
                            <p id="analysis-status" style="color:#fed; font-size:18px; margin-top:8px;">
                                Waiting for input...
                            </p>
                        </div>

                        <!-- Analysis Text -->
                        <div id="aiAnalysisText" class="text-sm text-gray-400 mb-4 font-mono bg-black/30 p-3 rounded-lg border border-gray-700">
                            System Idle. Waiting for input...
                        </div>

                        <!-- Match List -->
                        <div id="matchList" class="space-y-4 overflow-y-auto max-h-[400px] pr-2 custom-scrollbar">
                            <!-- Matches Injected Here -->
                            <div class="text-center py-20 opacity-30">
                                <i class="ph-duotone ph-fingerprint text-6xl mb-4"></i>
                                <p>No scan data available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- 7. REPORT DETAILS VIEW -->
    <template id="view-report-details">
        <div class="max-w-3xl mx-auto px-4 py-10 animate-slide-up w-full">
            
            <button onclick="navigateTo('search-image')" 
                class="mb-6 flex items-center text-gray-400 hover:text-white transition-colors">
                <i class="ph-bold ph-arrow-left mr-2"></i> Back to AI Search
            </button>
            
            <div class="glass-panel p-8 rounded-3xl shadow-xl">
    
                <div id="details-photo-container" class="w-full h-72 rounded-2xl overflow-hidden bg-black/20 mb-6">
                    <img id="details-photo" class="w-full h-full object-cover"/>
                </div>
    
                <h2 id="details-name" class="text-4xl font-display font-bold mb-4"></h2>
    
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                    <div class="glass-card p-4 rounded-xl">
                        <p class="text-sm text-gray-400 uppercase font-semibold">Age</p>
                        <p id="details-age" class="text-xl font-bold text-white"></p>
                    </div>
                    <div class="glass-card p-4 rounded-xl">
                        <p class="text-sm text-gray-400 uppercase font-semibold">Gender</p>
                        <p id="details-gender" class="text-xl font-bold text-white"></p>
                    </div>
                    <div class="glass-card p-4 rounded-xl">
                        <p class="text-sm text-gray-400 uppercase font-semibold">Last Seen</p>
                        <p id="details-last-seen" class="text-xl font-bold text-white"></p>
                    </div>
                    <div class="glass-card p-4 rounded-xl">
                        <p class="text-sm text-gray-400 uppercase font-semibold">Location</p>
                        <p id="details-location" class="text-xl font-bold text-white"></p>
                    </div>
                    <div class="glass-card p-4 rounded-xl sm:col-span-2">
                        <p class="text-sm text-gray-400 uppercase font-semibold">Contact Phone</p>
                        <p id="details-phone" class="text-xl font-bold text-white"></p>
                    </div>
                </div>
    
                <h3 class="text-xl font-display font-bold mb-2 text-purple-300">Description</h3>
                <p id="details-description"
                   class="text-gray-300 leading-relaxed bg-white/5 p-4 rounded-xl border border-white/10 mb-8"></p>
    
                <h3 class="text-xl font-display font-bold mb-2 text-indigo-300">Status</h3>
                <p id="details-status" class="text-lg font-bold px-4 py-2 rounded-xl inline-block mb-6"></p>
    
                <!-- ACTION BUTTONS -->
                <div class="grid grid-cols-1 gap-4">
                    
                    <button onclick="downloadPoster()"
                        class="bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-semibold transition text-white flex justify-center items-center gap-2">
                        <i class="ph-bold ph-file-pdf"></i> Download Missing Person Poster (A4)
                    </button>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="markAsFound()"
                            class="bg-green-600 hover:bg-green-500 py-3 rounded-xl font-semibold transition text-white flex justify-center items-center gap-2">
                            <i class="ph-bold ph-check-circle"></i> Mark as Found
                        </button>
                        
                        <button onclick="markAsPending()"
                            class="bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-semibold transition text-white flex justify-center items-center gap-2">
                            <i class="ph-bold ph-clock"></i> Mark as Pending
                        </button>
                    </div>

                    <button onclick="showQR()"
                        class="bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-semibold transition text-white flex justify-center items-center gap-2">
                        <i class="ph-bold ph-qr-code"></i> Show QR Code
                    </button>
    
                </div>
    
                <!-- QR CODE -->
                <div id="qrContainer" class="hidden mt-6 text-center">
                    <img id="qrImage" style="width:200px;height:200px;border-radius:10px;">
                    <p class="text-sm text-gray-400">Scan to view this report online</p>
                </div>
    
            </div>
        </div>
    </template>

    <!-- NOTIFICATION MODAL -->
    <div id="customModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="glass-panel p-8 rounded-2xl max-w-sm w-full mx-4 text-center transform scale-95 transition-transform duration-300" id="modalContent">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary/40">
                <i class="ph-bold ph-info text-3xl text-white"></i>
            </div>
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-2">Notification</h3>
            <p id="modalMessage" class="text-gray-300 mb-6 text-sm">Message goes here.</p>
            <button id="modalCloseBtn" class="w-full py-3 bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl font-semibold transition-colors">
                Dismiss
            </button>
        </div>
    </div>

    <script>
        // =======================================
        // GLOBAL VARIABLES & CONFIG
        // =======================================
        const API_BASE = "http://127.0.0.1:5000"; 
        let currentUser = null; 
        let currentReports = []; 

        // OTP Globals
        let otpPurpose = "";
        let otpEmail = "";
        let otpExtraPayload = {}; // extra values (name, password) for register

        // Progress message area
        function updateStatus(msg) {
            const statusText = document.getElementById("analysis-status");
            if (statusText) {
                statusText.innerHTML = "ðŸ”„ " + msg;
            }
        }

        async function openReportDetails(reportId) {
            try {
                const res = await fetch(`${API_BASE}/api/report/${reportId}`);
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem("selectedReport", JSON.stringify(data.report));
                    navigateTo("report-details");
                } else {
                    showModal("Error", "Failed to load report details.");
                }
            } catch (err) {
                showModal("Error", "Server error. Cannot load details.");
            }
        }

        // =======================================
        // NAVIGATION & ROUTING (Template Based)
        // =======================================
        function navigateTo(viewName) {
            const container = document.getElementById("app-container");
            const template = document.getElementById(`view-${viewName}`);
            
            if (!template) {
                console.error(`View ${viewName} not found`);
                return;
            }

            // Route Guard
            if ((viewName === 'dashboard' || viewName === 'report-form') && !currentUser) {
                showModal("Access Denied", "Please log in to access this secure area.");
                navigateTo('login');
                return;
            }

            // Clone and Inject
            container.innerHTML = '';
            container.appendChild(template.content.cloneNode(true));
            
            // View Specific Logic
            if (viewName === 'dashboard') loadDashboardReports();
            if (viewName === 'report-details') loadReportDetails();
            
            // Init Google Button if on Login page
            if (viewName === 'login') {
                setTimeout(loadGoogleButton, 100);
            }

            // Update Auth UI in Header
            updateHeaderAuthUI();

            window.scrollTo(0,0);
        }

        function updateHeaderAuthUI() {
            const guestNav = document.getElementById("auth-guest");
            const userNav = document.getElementById("auth-user");
            const ctaRegister = document.getElementById("cta-register");

            if (currentUser) {
                guestNav.classList.add("hidden");
                userNav.classList.remove("hidden");
                
                document.getElementById("header-username").innerText = currentUser.name;
                document.getElementById("header-initial").innerText = currentUser.name.charAt(0).toUpperCase();
                
                // Dashboard Nav Item
                document.getElementById("nav-dashboard").classList.remove("hidden");
                if(ctaRegister) ctaRegister.classList.add("hidden");
            } else {
                guestNav.classList.remove("hidden");
                userNav.classList.add("hidden");
                document.getElementById("nav-dashboard").classList.add("hidden");
                if(ctaRegister) ctaRegister.classList.remove("hidden");
            }
        }
        
        function loadReportDetails() {
            const r = JSON.parse(localStorage.getItem("selectedReport"));
            if (!r) {
                showModal("Error", "No report selected.");
                return;
            }
        
            // CHANGE #3: Removed /images/ prefix -> User wants it back with split
            document.getElementById("details-photo").src = r.photoPath;
            
            document.getElementById("details-name").innerText = r.name;
            document.getElementById("details-age").innerText = r.age;
            document.getElementById("details-gender").innerText = r.gender;
            document.getElementById("details-last-seen").innerText = r.last_seen_date;
            document.getElementById("details-location").innerText = r.location;
            document.getElementById("details-phone").innerText = r.phone || "Not Provided";
            document.getElementById("details-description").innerText = r.description;
        
            const statusElem = document.getElementById("details-status");
            statusElem.innerText = r.status;
            
            if (r.status === "Found") {
                statusElem.className = "text-green-400 bg-green-500/20 border border-green-500/20 px-4 py-2 rounded-xl inline-block";
            } else if (r.status === "Pending") {
                statusElem.className = "text-yellow-400 bg-yellow-500/20 border border-yellow-500/20 px-4 py-2 rounded-xl inline-block";
            } else {
                statusElem.className = "text-red-400 bg-red-500/20 border border-red-500/20 px-4 py-2 rounded-xl inline-block";
            }
        }

        async function showQR() {
            const r = JSON.parse(localStorage.getItem("selectedReport"));
            const res = await fetch(`${API_BASE}/api/report-qr/${r.id}`);
            const data = await res.json();

            if(data.success){
                document.getElementById("qrImage").src = data.qr_url;
                document.getElementById("qrContainer").classList.remove("hidden");
            }
        }

        function downloadPoster() {
            const r = JSON.parse(localStorage.getItem("selectedReport"));
            if(r && r.id) {
                window.open(`${API_BASE}/api/report-poster/${r.id}`, "_blank");
            }
        }

        async function markAsFound() {
            const r = JSON.parse(localStorage.getItem("selectedReport"));
            if(!r) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/update-status`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ reportId: r.id, status: "Found" })
                });

                const data = await res.json();
                if (data.success) {
                    r.status = "Found";
                    localStorage.setItem("selectedReport", JSON.stringify(r));
                    loadReportDetails();
                    showModal("Status Updated", "Marked as FOUND");
                } else {
                    showModal("Error", data.message || "Update failed");
                }
            } catch (err) {
                showModal("Error", "Connection failed");
            }
        }

        async function markAsPending() {
            const r = JSON.parse(localStorage.getItem("selectedReport"));
            if(!r) return;

            try {
                const res = await fetch(`${API_BASE}/api/update-status`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ reportId: r.id, status: "Pending" })
                });

                const data = await res.json();
                if (data.success) {
                    r.status = "Pending";
                    localStorage.setItem("selectedReport", JSON.stringify(r));
                    loadReportDetails();
                    showModal("Status Updated", "Marked as PENDING");
                } else {
                    showModal("Error", data.message || "Update failed");
                }
            } catch (err) {
                showModal("Error", "Connection failed");
            }
        }

        function downloadPDF() {
            const r = JSON.parse(localStorage.getItem("selectedReport"));
            window.open(`${API_BASE}/api/report-pdf/${r.id}`, "_blank");
        }

        async function toggleFoundStatus() {
            // Deprecated in favor of specific buttons, but kept for compatibility if needed
            markAsFound();
        }

        // =======================================
        // OTP & AUTH FUNCTIONS
        // =======================================
        
        function openOtpModal(purpose, email, extra={}) {
            otpPurpose = purpose;
            otpEmail = email;
            otpExtraPayload = extra;

            document.getElementById("otpModal").classList.remove("hidden");
            document.getElementById("otpModal").classList.add("flex");
        }

        function closeOtpModal() {
            document.getElementById("otpModal").classList.add("hidden");
            document.getElementById("otpModal").classList.remove("flex");
        }

        // Register Step 1: Send OTP
        async function handleRegister(e) {
            e.preventDefault();

            const name = document.getElementById("registerName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;

            // Send OTP
            try {
                const res = await fetch(`${API_BASE}/api/send-otp`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (data.success) {
                    openOtpModal("register", email, {name, password});
                } else {
                    showModal("Error", data.message);
                }
            } catch (error) {
                console.error(error);
                showModal("Connection Error", "Is the Flask backend running?");
            }
        }

        // Register Step 2: Verify OTP
        async function verifyRegisterOTP(otp) {
            const { name, password } = otpExtraPayload;

            try {
                const res = await fetch(`${API_BASE}/api/verify-register-otp`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ email: otpEmail, otp, name, password })
                });

                const data = await res.json();
                if (data.success) {
                    closeOtpModal();
                    showModal("Success", "Registration completed!");
                    navigateTo("login");
                } else {
                    showModal("Error", data.message);
                }
            } catch (error) {
                showModal("Error", "Failed to verify registration OTP.");
            }
        }

        // Login Step 1: Send OTP
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById("loginEmail").value;

            try {
                // Send OTP
                const res = await fetch(`${API_BASE}/api/send-otp`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (data.success) {
                    openOtpModal("login", email);
                } else {
                    showModal("Login Error", data.message);
                }
            } catch (error) {
                console.error(error);
                showModal("Connection Error", "Is the Flask backend running?");
            }
        }

        // Login Step 2: Verify OTP
        async function verifyLoginOTP(otp) {
            try {
                const res = await fetch(`${API_BASE}/api/verify-login-otp`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ email: otpEmail, otp })
                });

                const data = await res.json();

                if (data.success) {
                    currentUser = {
                        uid: data.userId,
                        name: data.name,
                        email: data.email
                    };
                    closeOtpModal();
                    updateHeaderAuthUI(); // uses global currentUser
                    navigateTo("dashboard");
                } else {
                    showModal("Error", data.message);
                }
            } catch (error) {
                 showModal("Error", "Failed to verify login OTP.");
            }
        }
        
        // OTP Button Logic
        document.getElementById("verifyOtpBtn").onclick = () => {
            const otp = document.getElementById("otpInput").value;
            if (otpPurpose === "register") verifyRegisterOTP(otp);
            else verifyLoginOTP(otp);
        };

        function handleLogout() {
            currentUser = null;
            navigateTo("home");
            showModal("Logged Out", "Session terminated securely.");
        }

        // =======================================
        // GOOGLE AUTH
        // =======================================

        function loadGoogleButton() {
            // Check if google script is loaded
            if (typeof google === 'undefined') return;

            google.accounts.id.initialize({
                client_id: "1234567890-abcdefg12345.apps.googleusercontent.com",
                callback: handleGoogleResponse
            });

            const btnContainer = document.getElementById("googleBtn");
            if(btnContainer) {
                google.accounts.id.renderButton(
                    btnContainer,
                    { theme: "outline", size: "large" }
                );
            }
        }

        function handleGoogleResponse(response) {
            fetch(`${API_BASE}/api/google-auth`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: response.credential })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentUser = {
                            uid: data.userId,
                            name: data.name,
                            email: data.email
                        };
                        updateHeaderAuthUI();
                        navigateTo("dashboard");
                    } else {
                        showModal("Google Login Failed", data.message);
                    }
                })
                .catch(err => console.error(err));
        }

        // =======================================
        // REPORT FUNCTIONS (Old Logic Preserved)
        // =======================================
        async function handleReportSubmission(e) {
            e.preventDefault();
            if (!currentUser) return;

            const form = document.getElementById("reportForm");
            const file = document.getElementById("reportPhoto").files[0];

            if (!file) {
                showModal("Missing Data", "A photo is required for the AI Engine.");
                return;
            }

            const formData = new FormData();
            formData.append("userId", currentUser.uid);
            formData.append("name", document.getElementById("reportName").value);
            formData.append("age", document.getElementById("reportAge").value);
            formData.append("gender", document.getElementById("reportGender").value);
            formData.append("location", document.getElementById("reportLocation").value);
            // Added Phone Field
            formData.append("phone", document.getElementById("reportPhone").value);
            
            formData.append("lastSeenDate", document.getElementById("reportLastSeen").value);
            formData.append("description", document.getElementById("reportDescription").value);
            formData.append("photo", file);

            const btn = document.getElementById("submitReportBtn");
            const originalText = btn.innerText;
            btn.innerText = "Encrypting & Uploading...";
            btn.disabled = true;

            try {
                const response = await fetchWithRetry(`${API_BASE}/api/report`, { method: 'POST', body: formData });
                const data = await response.json();

                if (data.success) {
                    showModal("Success", "Report added to database.");
                    navigateTo("dashboard");
                } else {
                    showModal("Error", data.message);
                }
            } catch (error) {
                showModal("Error", "Submission failed.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function loadDashboardReports() {
            const list = document.getElementById("reportsList");
            list.innerHTML = `<div class="col-span-full flex justify-center py-10"><div class="neon-loader border-white"></div></div>`;

            try {
                const response = await fetchWithRetry(`${API_BASE}/api/user-reports/${currentUser.uid}`);
                const data = await response.json();
                
                // Update Stats
                if(data.reports) {
                    document.getElementById("dash-total").innerText = data.reports.length;
                    document.getElementById("dash-active").innerText = data.reports.length; // Simplified logic
                }

                displayDashboardReports(data.success && data.reports ? data.reports : []);
            } catch (error) {
                list.innerHTML = `<p class="col-span-full text-center text-red-400">Error connecting to backend.</p>`;
            }
        }

        async function deleteReport(id) {
            if(!confirm("Are you sure you want to delete this report permanently?")) return;

            try {
                const res = await fetch(`${API_BASE}/api/delete-report/${id}`, {
                    method: "DELETE"
                });

                const data = await res.json();
                if(data.success){
                    showModal("Deleted", "Report removed successfully.");
                    loadDashboardReports();  // refresh UI
                } else {
                    showModal("Error", data.message);
                }
            } 
            catch(err){
                showModal("Error", "Server not reachable.");
            }
        }

        function displayDashboardReports(reports) {
            const list = document.getElementById("reportsList");
            if (!list) return;

            if (reports.length === 0) {
                list.innerHTML = `
                    <div class="col-span-full glass-card p-10 rounded-2xl text-center border-dashed border border-gray-600">
                        <i class="ph-duotone ph-folder-open text-4xl text-gray-500 mb-4"></i>
                        <p class="text-gray-400">No active reports found in your secure file.</p>
                    </div>`;
                return;
            }

            list.innerHTML = reports.map(r => `
                <div class="glass-card rounded-2xl overflow-hidden group hover:border-primary/50 transition-colors">
                    
                    <div class="h-48 relative overflow-hidden bg-black/50">
                        <img src="http://127.0.0.1:5000/images/${r.image_path.replace('data/db_images/', '')}" 
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    </div>

                    <div class="p-5">
                        <h3 class="font-bold text-xl mb-2">${r.name}</h3>
                        <p class="text-gray-400 text-sm mb-3">${r.location}</p>
                        <span class="px-3 py-1 text-xs rounded-lg 
                            ${r.status === 'Found' ? 'bg-green-500/20 text-green-400':'bg-yellow-500/20 text-yellow-300'}">
                            ${r.status}
                        </span>

                        <div class="flex gap-3 mt-4">
                            <button onclick="openReportDetails(${r.id})" 
                                    class="px-3 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm text-white">
                                View
                            </button>

                            <!-- ðŸš¨ DELETE BUTTON HERE -->
                            <button onclick="deleteReport(${r.id})" 
                                    class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm text-white">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // =======================================
        // SEARCH FUNCTIONS (DeepFace Logic Preserved)
        // =======================================
        async function handleSearchSubmission(e) {
            e.preventDefault();
            const fileInput = document.getElementById("searchPhoto");
            const file = fileInput.files[0];
            
            if (!file) {
                showModal("Input Error", "Please provide a source image for analysis.");
                return;
            }

            const loadingDiv = document.getElementById("searchLoading");
            const analysisText = document.getElementById("aiAnalysisText");
            const matchList = document.getElementById("matchList");

            loadingDiv.classList.remove("hidden");
            matchList.innerHTML = '';
            
            // Initial Status
            updateStatus("Uploading image...");

            try {
                const base64Image = await fileToBase64(file);
                
                const response = await fetchWithRetry(`${API_BASE}/api/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Image })
                });

                // Simulated progress steps for better UX
                updateStatus("Processing with AI model...");
                await new Promise(r => setTimeout(r, 800));
                
                updateStatus("Extracting facial features...");
                await new Promise(r => setTimeout(r, 800));
                
                updateStatus("Comparing result with trained IMFDB dataset...");
                await new Promise(r => setTimeout(r, 800));

                const data = await response.json();

                if (data.success) {
                    const topMatch = data.matches && data.matches.length > 0 ? data.matches[0] : null;
                    const confidence = topMatch ? topMatch.similarity : 0;
                    
                    updateStatus("Match Confidence: " + confidence + "%");
                    await new Promise(r => setTimeout(r, 1000)); // Show confidence briefly

                    displaySearchResults(data.matches);
                } else {
                    updateStatus("Error: " + data.message);
                }
            } catch (error) {
                updateStatus("Error: Connection Failed");
            } finally {
                loadingDiv.classList.add("hidden");
            }
        }

        function displaySearchResults(matches) {
            const list = document.getElementById("matchList");

            if (!matches || matches.length === 0) {
                list.innerHTML = `<p class="text-gray-500 italic">No strong facial matches found in the database.</p>`;
                return;
            }

            // Sort highest similarity first
            matches.sort((a, b) => b.similarity - a.similarity);

            // CHANGE #1: Removed /images/ prefix to use raw backend path
            list.innerHTML = matches.map(m => `
                <div class="p-4 bg-card border border-gray-200 dark:border-gray-700 
                            rounded-lg flex flex-col sm:flex-row items-start sm:items-center 
                            gap-4 shadow-sm">

                    <img src="http://127.0.0.1:5000/images/${m.photoPath.replace('data/db_images/', '')}" 
                        onerror="this.src='https://placehold.co/80x80/ef4444/ffffff?text=NO+IMAGE'"
                        class="w-20 h-20 rounded-lg object-cover"/>

                    <div class="flex-grow">
                        <p class="font-bold text-lg text-[var(--primary-color)]">${m.name}</p>
                        <p class="text-sm font-semibold text-green-500">
                            Similarity: ${m.similarity}% Match
                        </p>
                        <p class="text-xs text-gray-400">Status: ${m.status}</p>
                    </div>

                    <button 
                        onclick="openReportDetails(${m.reportId})"
                        class="text-sm bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg shadow hover:bg-[var(--secondary-color)]">
                        View Details
                    </button>
                </div>
            `).join("");
        }

        // =======================================
        // UTILITIES
        // =======================================
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        function handleFilePreview(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    if(imgId === 'preview-search') document.getElementById('search-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showModal(title, message) {
            const modal = document.getElementById("customModal");
            const modalContent = document.getElementById("modalContent");
            document.getElementById("modalTitle").innerText = title;
            document.getElementById("modalMessage").innerText = message;
            
            modal.classList.remove("hidden");
            // Small timeout to allow display:block to apply before opacity transition
            setTimeout(() => {
                modal.classList.remove("opacity-0");
                modalContent.classList.remove("scale-95");
                modalContent.classList.add("scale-100");
            }, 10);
        }

        document.getElementById("modalCloseBtn").onclick = () => {
            const modal = document.getElementById("customModal");
            const modalContent = document.getElementById("modalContent");
            
            modal.classList.add("opacity-0");
            modalContent.classList.remove("scale-100");
            modalContent.classList.add("scale-95");
            
            setTimeout(() => {
                modal.classList.add("hidden");
            }, 300);
        };

        // Initialize
        document.addEventListener("DOMContentLoaded", () => {
            navigateTo('home');
        });

    </script>
</body>
</html>